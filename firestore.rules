rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // USER PROFILE: Users can read and write their own profile data only
    match /user_profile/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isSignedIn();
    }

    // MISSION CATALOG: Read-only for all authenticated users (public quest data)
    match /mission_catalog/{missionId} {
      allow read: if isSignedIn();
      allow write: if false; // No client-side writes
    }

    // EXPEDITION CATALOG: Read-only for all authenticated users (quest groups)
    match /expedition_catalog/{expeditionId} {
      allow read: if isSignedIn();
      allow write: if false; // No client-side writes
    }

    // BADGE CATALOG: Read-only for all authenticated users (available badges)
    match /badge_catalog/{badgeId} {
      allow read: if isSignedIn();
      allow write: if false; // No client-side writes
    }

    // MISSION STATUS: Users can read and update their own mission progress
    // Document ID format: {userId}_{missionId}
    match /mission_status/{statusId} {
      allow read: if isSignedIn() && statusId.matches('^' + request.auth.uid + '_.*');
      allow create, update: if isSignedIn() && statusId.matches('^' + request.auth.uid + '_.*');
      allow delete: if false; // Never allow deletion
    }

    // USER ACTIVITY LOG: Users can read their own activity, append-only for creates
    match /user_activity_log/{activityId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Append-only, no modifications
    }

    // HUD SYNC STATE: Users can read and write their own HUD state
    match /hud_sync_state/{userId} {
      allow read, write: if isOwner(userId);
    }

    // LEVEL PROGRESSION TABLE: Read-only for all authenticated users
    match /level_progression_table/{level} {
      allow read: if isSignedIn();
      allow write: if false; // No client-side writes
    }

    // QUIZ CATALOG: Read-only for all authenticated users
    match /quiz_catalog/{quizId} {
      allow read: if isSignedIn();
      allow write: if false; // No client-side writes
    }

    // LEADERBOARD: Read-only for all authenticated users
    match /leaderboard/{userId} {
      allow read: if isSignedIn();
      allow write: if false; // Updated by Cloud Functions only
    }

    // AURA CONVERSATION HISTORY: Users can read and write their own conversations
    match /aura_conversation_history/{conversationId} {
      allow read, create, update: if isSignedIn() && 
        (resource == null || resource.data.userId == request.auth.uid) &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if false; // Never delete conversation history
    }

    // SYSTEM CONFIG: Read-only for all authenticated users (global settings)
    match /system_config/{configKey} {
      allow read: if isSignedIn();
      allow write: if false; // Admin only, no client-side writes
    }
  }
}
